<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Simple Chat Online</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:Arial, sans-serif;}  
  body{background:#0f111a;color:#fff;height:100vh;display:flex;}
  .sidebar{width:280px;background:#151823;border-right:1px solid #222;padding:15px;display:flex;flex-direction:column;}
  .search input{width:100%;padding:10px;border-radius:8px;border:none;background:#1b1f2c;color:#fff;margin-bottom:10px;}
  .contacts{flex:1;overflow-y:auto;margin-top:10px;}
  .contact{padding:10px;background:#1b1f2c;margin-bottom:8px;border-radius:10px;cursor:pointer;}   
  .contact:hover{background:#252a3a;}
  .active{background:#2d3250!important;}
  .chat{flex:1;display:flex;flex-direction:column;}
  .messages{flex:1;padding:20px;overflow-y:auto;}
  .msg{margin-bottom:15px;}
  .me{color:#7fc4ff;}
  .friend{color:#f2a2ff;}
  .inputArea{display:flex;padding:15px;border-top:1px solid #222;} 
  .inputArea input{flex:1;padding:12px;border-radius:8px;border:none;background:#1b1f2c;color:#fff;} 
  .inputArea button{margin-left:10px;padding:12px 18px;border:none;border-radius:8px;background:#4c6ef5;color:#fff;cursor:pointer;} 
  .addFriend{display:flex;margin-top:10px;} 
  .addFriend input{flex:1;padding:10px;border-radius:8px;border:none;background:#1b1f2c;color:#fff;} 
  .addFriend button{margin-left:8px;padding:10px;background:#4c6ef5;border:none;border-radius:8px;color:#fff;cursor:pointer;} 
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="search">
    <input id="searchInput" placeholder="Поиск друзей по имени или ID..." />
  </div>

  <div style="font-size:14px;margin-bottom:10px;color:#999;">
    Ваш ID: <span id="myId" style="color:#4c6ef5;font-weight:bold"></span>
  </div>

  <div class="addFriend">
    <input id="friendName" placeholder="Имя друга или ID" />
    <button id="addFriendBtn">+</button>
  </div>

  <div class="contacts" id="contacts"></div>
</div>

<!-- CHAT AREA -->
<div class="chat">
  <div class="messages" id="messages"></div>
  <div class="inputArea">
    <input id="msgInput" placeholder="Написать сообщение..." />
    <button id="sendBtn">Отправить</button>
  </div>
</div>

<script>
// ---------------------------
// FIREBASE CONFIG
// ---------------------------
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------------------------
// LOCAL STATE
// ---------------------------
let state = {
  myId: localStorage.getItem("myId") || null,
  contacts: []
};

function uid(){ return Math.random().toString(36).substring(2,10); }

if(!state.myId){
  state.myId = "id_" + uid();
  localStorage.setItem("myId", state.myId);
}
document.getElementById("myId").textContent = state.myId;

// ---------------------------
// CONTACTS
// ---------------------------
let activeChat = null;
const contactsDiv = document.getElementById("contacts");

function renderContacts(filter=""){
  contactsDiv.innerHTML = "";
  state.contacts
    .filter(c=> c.name.toLowerCase().includes(filter.toLowerCase()) || c.id.includes(filter))
    .forEach(c=>{
      const el = document.createElement("div");
      el.className = "contact" + (activeChat===c.id?" active":"");
      el.textContent = c.name + " (" + c.id + ")";
      el.onclick = ()=>{ activeChat = c.id; renderContacts(filter); listenMessages(activeChat); };
      contactsDiv.appendChild(el);
    });
}

document.getElementById("addFriendBtn").onclick = ()=>{
  let input = document.getElementById("friendName").value.trim();
  if(!input) return;

  let id, name;
  if(/^id_[a-z0-9]{6,}$/.test(input)){
    id = input;
    name = "Friend_" + id.slice(-4);
  } else {
    id = "id_" + uid();
    name = input;
  }

  if(!state.contacts.some(c=>c.id===id)){
    state.contacts.push({id,name});
  }

  document.getElementById("friendName").value="";
  renderContacts();
};

// Поиск контактов
document.getElementById("searchInput").oninput = function(){
  const v = this.value.trim();
  renderContacts(v);
};

renderContacts();

// ---------------------------
// MESSAGES
// ---------------------------
function listenMessages(chatId){
  const box = document.getElementById("messages");
  box.innerHTML = "";

  db.ref('messages/' + chatId).off();
  db.ref('messages/' + chatId).on('child_added', snapshot=>{
    const m = snapshot.val();
    const d = document.createElement("div");
    d.className="msg " + (m.from===state.myId?"me":"friend");
    d.textContent = m.text;
    box.appendChild(d);
    box.scrollTop = box.scrollHeight;
  });
}

function send(){
  if(!activeChat) return;
  const txt = document.getElementById("msgInput").value.trim();
  if(!txt) return;
  const msg = {from:state.myId, text:txt, time:Date.now()};
  db.ref('messages/' + activeChat).push(msg);
  document.getElementById("msgInput").value="";
}

document.getElementById("sendBtn").onclick = send;
document.getElementById("msgInput").onkeydown = e=>{ if(e.key==="Enter") send(); };
</script>
</body>
</html>
